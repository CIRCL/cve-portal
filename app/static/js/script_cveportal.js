// ADMIN USER MANAGEMENT PART //
$usertable = $('#usertable').bootstrapTable({
});


$('#update-user').click(function () {
    $.ajax({
        type: "POST",
        contentType: "application/json; charset=utf-8",
        url: "/updateuser",
        dataType: "json",
        data: JSON.stringify($usertable.bootstrapTable('getSelections')),
        success: function(){
            location.reload();
        },
    });
});


$('#btn-delete-ok').click(function () {
    $.ajax({
        type: "POST",
        contentType: "application/json; charset=utf-8",
        url: "/deleteuser",
        dataType: "json",
        data: JSON.stringify($usertable.bootstrapTable('getSelections')),
        success: function(){
            location.reload();
        },
    });
});


// USER NOTIFICATION MANAGEMENT //
$notiftable = $('notiftable').bootstrapTable({
});


function operateFormatter(value, row, index) {
    return [
        '<a class="removenotif" href="#" title="Remove">',
        '<i class="glyphicon glyphicon-remove"></i>',
        '</a>',
        '<a class="checknotif" href="#" title="Check">',
        '<i class="glyphicon glyphicon-search"></i>',
        '</a>'
            ].join('  ');
}

function dateFormatter(value, row, index){
    var d = new Date(value);
    return d
}

function refFormatter(value, row, index){
    var tab = String(value).split(',');
    var ref = [];
    for (var j = 0; j < tab.length; j++){
        ref.push('<a href="'+tab[j]+'">'+tab[j]+'</a>');
    };
    return ref.join('</br>');
}

window.operateEvents = {
    'click .removenotif': function (e, value, row, index){
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: "/delnotif",
            dataType: "json",
            data: JSON.stringify(row['id']),
            success: function() {
                location.reload();
            },
        });

    },
    'click .checknotif': function (e, value, row, index){
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: "/checknotif",
            dataType: "json",
            data: JSON.stringify(row),
            success: function(data) {
                $('#CheckNotifModal').modal('show');
                $('#cvestab').bootstrapTable('destroy', {});
                $('#cvestab').bootstrapTable({
                    method: 'post',
                    data: data,
                    search: true,
                    showToggle: true,
                    showColumns: true,
                    height: 600,
                    minimumCountColumns: 2,
                    searchAlign: 'left',
                    striped: true,
                    cache: false,
                    pagination: true,
                    columns:[
                        {
                        field: 'id',
                        title: 'CVE ID',
                        align: 'right',
                        sortable: true},
                        {
                        field: 'Modified',
                        title: 'Last Update',
                        align: 'right',
                        formatter: dateFormatter,
                        sortable: true},
                        {
                        field: 'Published',
                        title: 'Published',
                        align: 'right',
                        visible: false,
                        formatter: dateFormatter,
                        sortable: true},
                        {
                        field: 'cvss',
                        title: 'CVSS',
                        visible: false,
                        align: 'right'},
                        {
                        field: 'cwe',
                        title: 'CWE',
                        align: 'right',
                        visible: false,
                        sortable: true},
                        {
                        field: 'summary',
                        title: 'Summary',
                        align: 'right'},
                        {
                        field: 'references',
                        title: 'References',
                        visible: false,
                        formatter: refFormatter,
                        align: 'right'},
                        {
                        field: 'vulnerable_configuration',
                        title: 'Vulnerable Conf',
                        visible: false,
                        align: 'right'}
                        ]
                });
            },
        });
    }
}


var delay = (function(){
    var timer = 0;
    return function(callback, ms){
        clearTimeout(timer);
        timer = setTimeout(callback, ms)
    };
})();

$('#allproduct').on("click", function(){
    if($(this).is(':checked')){
        $('#product').val('');
        $('#version').val('');
        $('#product').parent().toggleClass('has-warning has-success', false);
        $('#product').attr('disabled', true);
        $('#version').attr('disabled', true);
        $('#allversion').attr('disabled', true);
        $('#allversion').prop('checked', true);
    }else{
        $('#product').removeAttr("disabled");
        $('#version').removeAttr("disabled");
        $('#allversion').prop('checked', false);
        $('#allversion').attr('disabled', false);
    };
});

$('#allversion').on("click", function(){
    if($(this).is(':checked')){
        $('#version').val('');
        $('#version').parent().toggleClass('has-warning has-success', false);
        $('#version').attr('disabled', true);
    }else{
        $('#version').removeAttr("disabled");
    };
});

$('#vendor-dropdown').on("click", "li.searchterm", function() {
    var value = $(this).text();
    $('#vendor').val(value);
});


$('#product-dropdown').on("click", "li.searchterm", function() {
    var value = $(this).text();
    $('#product').val(value);
    if ($('#vendor').val() == '' && $('#product').parent().hasClass('has-success')){
        $('#vendor').val($('ul#vendor-dropdown.dropdown-menu').text());
    }
});


$('#version-dropdown').on("click", "li.searchterm", function() {
    var value = $(this).text();
    $('#version').val(value);
});


$('#vendor').on("keyup click focusout", function () {
    delay(function(){
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: "/notifjson",
            dataType: "json",
            data: JSON.stringify(
                {"queryvendor":$('#vendor').val(),
                 "queryproduct":$('#product').val(),
                 "queryversion":$('#version').val()
                }),
            success: function(data){
                var vendors = data['vendors'];
                $('#vendor-dropdown').empty();
                for (var i = 0; i < vendors.length; i++){
                    $('#vendor-dropdown').append('<li class="searchterm"><a href="#">'+vendors[i]+'</a></li>');
                };
                if ($.inArray($('#vendor').val(), vendors) == 0){ //SUCCESS
                    $('#vendor').parent().toggleClass('has-warning', false);
                    $('#vendor').parent().toggleClass('has-success', true);
                } else {
                    $('#vendor').parent().toggleClass('has-success', false);
                    $('#vendor').parent().toggleClass('has-warning', true);
                };
            },
        });
    }, 0 );
});


$('#product').on("keyup click focusout hover", function () {
delay(function(){
    $.ajax({
        type: "POST",
        contentType: "application/json; charset=utf-8",
        url: "/notifjson",
        dataType: "json",
        data: JSON.stringify(
            {"queryvendor":$('#vendor').val(),
             "queryproduct":$('#product').val(),
             "queryversion":$('#version').val()
            }),
        success: function(data){
            var products = data['products'];
            var vendors = data['vendors'];
            $('#product-dropdown').empty();
            $('#vendor-dropdown').empty();
            for (var j = 0; j < products.length; j++){
                $('#product-dropdown').append('<li class="searchterm"><a href="#">'+products[j]+'</a></li>');
            };
            if ($.inArray($('#product').val(), products) == 0){
                $('#product').parent().toggleClass('has-warning', false);
                $('#product').parent().toggleClass('has-success', true);
            } else {
                $('#product').parent().toggleClass('has-success', false);
                $('#product').parent().toggleClass('has-warning', true);
            };

            $('#vendor-dropdown').append('<li class="searchterm"><a href="#">'+vendors[0]+'</a></li>');
        },
    });
}, 0 );
});


$('#version').on("keyup click focusout", function () {
delay(function(){
    $.ajax({
        type: "POST",
        contentType: "application/json; charset=utf-8",
        url: "/notifjson",
        dataType: "json",
        data: JSON.stringify(
            {"queryvendor":$('#vendor').val(),
             "queryproduct":$('#product').val(),
             "queryversion":$('#version').val()
            }),
        success: function(data){
            var versions = data['versions'];
            $('#version-dropdown').empty();
            for (var j = 0; j < versions.length; j++){
                $('#version-dropdown').append('<li class="searchterm"><a href="#">'+versions[j]+'</a></li>');
            };
            // FIXME: int/string: sometime fail version comparison.
            if ($.inArray($('#version').val(), versions) == 0){
                $('#version').parent().toggleClass('has-warning', false);
                $('#version').parent().toggleClass('has-success', true);
            } else {
                $('#version').parent().toggleClass('has-success', false);
                $('#version').parent().toggleClass('has-warning', true);
            };
        },
    });
}, 0 );
});


// Reseting form for further add.
$('#add-notif').on("click", function(){
    $('#vendor').val('');
    $('#product').val('');
    $('#version').val('');
    $('#product').removeAttr("disabled");
    $('#version').removeAttr("disabled");
    $('#allversion').prop('checked', false);
    $('#allversion').attr('disabled', false);
    $('#allproduct').prop('checked', false);
    $('#vendor').parent().removeClass('has-warning has-success');
    $('#product').parent().removeClass('has-warning has-success');
    $('#version').parent().removeClass('has-warning has-success');

});


$('#delete-notif').on("click", function() {
    var selected_notif = []
    for (var j = 0; j < $('#notiftable').bootstrapTable('getSelections').length; j++){
        selected_notif.push($('#notiftable').bootstrapTable('getSelections')[j]['id'])
    }
    $.ajax({
        type: "POST",
        contentType: "application/json; charset=utf-8",
        url: "/delnotif",
        dataType: "json",
        data: JSON.stringify(selected_notif),
        success: function() {
            location.reload();
        },
    });
});

// Add notification in the database.
$('#btn-add-notif').on("click", function() {
    $.ajax({
        type: "POST",
        contentType: "application/json; charset=utf-8",
        url: "/addnotif",
        dataType: "json",
        data: JSON.stringify(
            {"queryvendor":$('#vendor').val(),
             "queryproduct":$('#product').val(),
             "queryversion":$('#version').val(),
             "allproduct":$('#allproduct').is(':checked'),
             "allversion":$('#allversion').is(':checked')}),
        success: function() {
            location.reload();
        },
    });
});

